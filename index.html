<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f0f0f0; /* Серый фон */
            margin: 0;
            padding: 20px;
        }
    </style>
</head>
<body>
    <h1>Привет, <span id="username"></span>!</h1>
    <h2>Очки: <span id="score">0</span></h2>
    <button id="saveButton">Сохранить данные</button>
    <button id="getButton">Получить данные</button>
    <button id="addPointsButton">Добавить 23 очка</button>

    <script>
        const user = Telegram.WebApp.initDataUnsafe.user;

        if (user) {
            const userId = user.id;
            const userKey = `userInfo_${userId}`;
            const usernameElement = document.getElementById('username');
            const scoreElement = document.getElementById('score');

            usernameElement.textContent = user.first_name;

            // Функция для получения данных пользователя
            const getCurrentUserData = () => {
                return CloudStorage.getValue(userKey).then((value) => {
                    return value ? JSON.parse(value) : { username: user.first_name, score: 0 };
                });
            };

            // Обработчик для сохранения данных
            document.getElementById('saveButton').addEventListener('click', () => {
                const userData = { username: user.first_name, score: parseInt(scoreElement.textContent) || 0 };
                CloudStorage.setValue(userKey, JSON.stringify(userData))
                    .then(() => {
                        Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                        alert('Данные успешно сохранены!');
                    })
                    .catch((error) => {
                        console.error('Ошибка при сохранении данных:', error);
                    });
            });

            // Обработчик для получения данных
            document.getElementById('getButton').addEventListener('click', () => {
                getCurrentUserData()
                    .then((userData) => {
                        scoreElement.textContent = userData.score;
                        alert(`Данные пользователя: ${userData.username}, Очки: ${userData.score}`);
                    })
                    .catch((error) => {
                        console.error('Ошибка при извлечении данных:', error);
                    });
            });

            // Обработчик для добавления очков
            document.getElementById('addPointsButton').addEventListener('click', () => {
                getCurrentUserData()
                    .then((userData) => {
                        userData.score += 23; // Увеличиваем очки на 23
                        return CloudStorage.setValue(userKey, JSON.stringify(userData));
                    })
                    .then(() => {
                        scoreElement.textContent = parseInt(scoreElement.textContent) + 23; // Обновляем отображение очков
                        Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                        alert(`Добавлено 23 очка! Теперь у вас ${scoreElement.textContent} очков.`);
                    })
                    .catch((error) => {
                        console.error('Ошибка при добавлении очков:', error);
                    });
            });

            // Загружаем данные при загрузке страницы
            getCurrentUserData()
                .then((userData) => {
                    scoreElement.textContent = userData.score; // Отображаем начальные очки
                })
                .catch((error) => {
                    console.error('Ошибка при получении начальных данных:', error);
                });
        } else {
            alert('Не удалось получить данные о пользователе.');
        }
    </script>
</body>
</html>
